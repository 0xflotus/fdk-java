version: 2
jobs:
  build:
    working_directory: ~/fn-java-fdk
    machine:
      java:
        version: oraclejdk8
    environment:
      ARTIFACT_DIR: /tmp/artifacts
    steps:
      - checkout
      - restore_cache:
          key: mvn-cache

      - run:
          name: Build, Test and Package.
          command: mvn package
      - run:
         name: Update Docker to latest
         command: ./.circleci/install-docker.sh
      - run:
         name: Login to Docker
         command: docker login -u $DOCKER_USER -p $DOCKER_PASS

      - store_test_results:
          path: runtime/target/surefire-reports
      - store_test_results:
          path: testing/target/surefire-reports

      - run:
          name: Copy FDK artifacts to upload folder
          command: |
            mkdir $ARTIFACT_DIR
            cp api/target/*.jar $ARTIFACT_DIR
            cp runtime/target/*.jar $ARTIFACT_DIR
      - store_artifacts:
          name: Upload FDK artifacts
          path: $ARTIFACT_DIR

      - run:
          name: Push to maven repo
          command: |
            mvn -s ./settings-deploy.xml \
                -DskipTests \
                -DaltDeploymentRepository="bmcs-faas-snapshot-repo::default::https://swiftobjectstorage.us-phoenix-1.oraclecloud.com/v1/opc0002/mvnrepo/snapshots" \
                -Dbmcs-faas-snapshot-repo.username="$MVN_SNAPSHOT_USER" \
                -Dbmcs-faas-snapshot-repo.password="$MVN_SNAPSHOT_PASSWORD" \
                deploy
      - run:
          name: Build fn-java-fdk Docker image
          command: |
            cd runtime
            docker build -t fnproject/fn-java-fdk .
      - run:
          name: Deploy fn-java-fdk Docker image
          command: docker push fnproject/fn-java-fdk

      - run:
          name: Update go to 1.8.3
          command: ./integration-tests/install-go.sh
      - run:
          name: Install fn binary (as it is needed for the integration tests)
          command: ./integration-tests/install-fn.sh
      - run:
          name: Run integration tests
          command: COMPLETER_DOCKER_IMAGE=willprice/completer ./integration-tests/run-local.sh
          timeout: 1200

      - save_cache:
          paths:
            - ~/.m2
          key: mvn-cache
